<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>OCR Tawkeel Fast Scanner</title>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; text-align:center; padding:16px; }
    #video, #canvasPreview { border:2px solid #444; border-radius:8px; margin-top:10px; }
    #roi-box { position:absolute; border:2px dashed red; width:250px; height:80px; top:150px; left:calc(50% - 125px); pointer-events:none; }
    #controls { margin-top:12px; }
    #result { font-size:20px; font-weight:bold; color:green; margin-top:12px; min-height:28px; }
  </style>
</head>
<body>
  <h3>OCR Tawkeel Fast Scanner</h3>

  <div style="position:relative; display:inline-block;">
    <video id="video" autoplay playsinline width="640" height="480"></video>
    <div id="roi-box"></div>
  </div>

  <canvas id="canvas" width="640" height="480" style="display:none"></canvas>
  <canvas id="roiCanvas" width="360" height="80" style="display:none"></canvas>

  <div id="result">Waiting...</div>
  <div id="controls">
    <button id="restartBtn">ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©</button>
    <button id="debugBtn">Toggle Preview</button>
  </div>

  <canvas id="canvasPreview" width="360" height="80" style="display:none; margin-top:10px;"></canvas>

<script>
  const video = document.getElementById('video');
  const canvas = document.getElementById('canvas');
  const ctx = canvas.getContext('2d', { willReadFrequently: true });
  const roiCanvas = document.getElementById('roiCanvas');
  const roiCtx = roiCanvas.getContext('2d', { willReadFrequently: true });
  const preview = document.getElementById('canvasPreview');
  const previewCtx = preview.getContext('2d');
  const resultBox = document.getElementById('result');
  const restartBtn = document.getElementById('restartBtn');
  const debugBtn = document.getElementById('debugBtn');

  // Ø¶Ø¨Ø· ROI Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ â€” Ø¹Ø¯Ù„Ù‡ Ù„ÙŠØ·Ø§Ø¨Ù‚ Ù…ÙˆØ¶Ø¹ Ø§Ù„Ø³Ø·Ø± ØªØ­Øª Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ ÙÙŠ ÙƒØ§Ù…ÙŠØ±ØªÙƒ
  const ROI = { x: 200, y: 320, w: 250, h: 60 }; // Ù…Ø¨Ø¯Ø¦ÙŠ â€” Ø¹Ø¯Ù‘Ù„ Y ÙˆX Ø­Ø³Ø¨ Ø§Ù„Ø­Ø§Ø¬Ø©

  // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø£Ø¯Ø§Ø¡
  let scanning = true;
  let ocrRunning = false;
  let lastAttempt = 0;
  const minInterval = 500; // ms Ø¨ÙŠÙ† Ù…Ø­Ø§ÙˆÙ„Ø§Øª OCR
  const requiredStable = 2; // Ø¹Ø¯Ø¯ Ù…Ø±Ø§Øª Ø§Ù„ØªÙƒØ±Ø§Ø± Ù„Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ù†ØªÙŠØ¬Ø©
  let lastText = null;
  let stableCount = 0;

  // Ù…Ø±Ø¦ÙŠ debug preview toggle
  let showPreview = false;
  debugBtn.addEventListener('click', () => {
    showPreview = !showPreview;
    preview.style.display = showPreview ? 'block' : 'none';
  });

  // ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§
  navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
    .then(s => { video.srcObject = s; })
    .catch(e => { resultBox.innerText = "Camera error: " + e; });

  // Tesseract worker re-used
  let worker;
  (async () => {
    worker = Tesseract.createWorker({
      logger: m => { /* console.log(m) */ }
    });
    await worker.load();
    await worker.loadLanguage('eng');
    await worker.initialize('eng');
    await worker.setParameters({
      tessedit_char_whitelist: 'ECP0123456789EG',
      tessedit_pageseg_mode: Tesseract.PSM.SINGLE_LINE,
      tessedit_ocr_engine_mode: Tesseract.OEM.LSTM_ONLY
    });
  })();

  // ØªØ­Ø¶ÙŠØ± Ø§Ù„Ù€ ROI: crop, resize, grayscale, contrast, threshold
  async function prepareROIBlob() {
    // Ø§Ø±Ø³ÙÙ… ÙØ±ÙŠÙ… Ø§Ù„ÙÙŠØ¯ÙŠÙˆ ÙƒØ§Ù…Ù„Ø§ Ø¹Ù„Ù‰ Ø§Ù„ÙƒØ§Ù†Ú¤Ø§Ø³ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

    // Ù‚Øµ Ø§Ù„Ø±ÙÙ‚Ø¹Ø© Ø¥Ù„Ù‰ roiCanvas Ø¨Ù‚ÙŠØ§Ø³ Ø£ØµØºØ± (Ù„ØªÙ‚Ù„ÙŠÙ„ Ø¹Ø¯Ø¯ Ø§Ù„Ø¨ÙƒØ³Ù„Ø§Øª)
    const targetW = roiCanvas.width;
    const targetH = roiCanvas.height;
    roiCtx.clearRect(0,0,targetW,targetH);
    roiCtx.drawImage(canvas, ROI.x, ROI.y, ROI.w, ROI.h, 0, 0, targetW, targetH);

    // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø¨Ø³ÙŠØ·Ø©: grayscale + contrast + threshold
    const img = roiCtx.getImageData(0,0,targetW,targetH);
    const data = img.data;
    const contrast = 1.5;
    const intercept = 128 * (1 - contrast);
    // Ø£ÙˆÙ„Ø§Ù‹ grayscale ÙˆØªØ¶Ø®ÙŠÙ… Ø§Ù„ØªØ¨Ø§ÙŠÙ†
    for (let i = 0; i < data.length; i += 4) {
      const g = 0.299*data[i] + 0.587*data[i+1] + 0.114*data[i+2];
      let v = g * contrast + intercept;
      data[i] = data[i+1] = data[i+2] = v;
    }
    // threshold Ø«Ø§Ø¨Øª Ø¨Ø¹Ø¯ Ø§Ù„ØªØ¶Ø®ÙŠÙ…
    const thresh = 150;
    for (let i = 0; i < data.length; i += 4) {
      const v = data[i] > thresh ? 255 : 0;
      data[i] = data[i+1] = data[i+2] = v;
    }
    roiCtx.putImageData(img, 0, 0);

    // Ø¹Ø±Ø¶ preview Ù„Ùˆ Ù…ÙØ¹Ù„
    if (showPreview) {
      previewCtx.clearRect(0,0,preview.width, preview.height);
      previewCtx.drawImage(roiCanvas, 0, 0, preview.width, preview.height);
    }

    // Ø¥Ø±Ø¬Ø§Ø¹ Blob Ø¬Ø§Ù‡Ø² Ù„Ù„Ù€ worker
    return new Promise(resolve => roiCanvas.toBlob(b => resolve(b), 'image/png'));
  }

  // Ø¯Ø§Ù„Ø© OCR Ù…Ø¹ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§Ø³ØªÙ‚Ø±Ø§Ø±
  async function doOCR() {
    if (!scanning || ocrRunning || !worker) return;
    const now = Date.now();
    if (now - lastAttempt < minInterval) return;
    lastAttempt = now;

    ocrRunning = true;
    try {
      const blob = await prepareROIBlob();
      const { data: { text } } = await worker.recognize(blob);

      // Ù†Ø­ØªÙØ¸ Ø¨ØªØ¹Ø¨ÙŠØ±Ùƒ Ø§Ù„Ù†Ù…Ø·ÙŠ ÙƒÙ…Ø§ Ù‡Ùˆ Ø¯ÙˆÙ† ØªØºÙŠÙŠØ±
      const cleaned = (text || '').replace(/\s+/g, '');
      const match = cleaned.match(/ECP\d{8}EG/); // <-- Ù†ÙØ³ Ø§Ù„Ø±ÙŠØ¬ÙŠÙƒØ³ Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ

      if (match) {
        const candidate = match[0];
        if (candidate === lastText) {
          stableCount++;
        } else {
          lastText = candidate;
          stableCount = 1;
        }

        if (stableCount >= requiredStable) {
          resultBox.innerText = "âœ… Detected: " + candidate;
          scanning = false;
        } else {
          resultBox.innerText = "Confirming: " + candidate + " (" + stableCount + "/" + requiredStable + ")";
        }
      } else {
        // Ù„Ø§ Ø§ÙƒØªØ´Ø§Ù: Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø¹Ø¯Ø§Ø¯
        lastText = null;
        stableCount = 0;
        resultBox.innerText = "Scanning...";
      }
    } catch (err) {
      console.error('OCR error', err);
    } finally {
      ocrRunning = false;
    }
  }

  // Ø­Ù„Ù‚Ø© Ø¨Ø³ÙŠØ·Ø© ØªØ³ØªØ¯Ø¹ÙŠ OCR Ø¨ØªØ±Ø¯Ø¯ Ù…Ù†Ø§Ø³Ø¨
  function loop() {
    if (!scanning) return;
    doOCR();
    requestAnimationFrame(loop);
  }

  restartBtn.addEventListener('click', () => {
    scanning = true;
    lastText = null;
    stableCount = 0;
    resultBox.innerText = "Waiting...";
    loop();
  });

  video.addEventListener('playing', () => {
    loop();
  });

  // ØªÙ†Ø¸ÙŠÙ worker Ø¹Ù†Ø¯ Ø§Ù„Ø®Ø±ÙˆØ¬
  window.addEventListener('beforeunload', async () => {
    if (worker) await worker.terminate();
  });

</script>
</body>
</html>