<!doctype html>
<html lang="ar">
<head>
  <meta charset="utf-8" />
  <title>OCR Tawkeel Reliable Scanner</title>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; text-align:center; padding:16px; }
    .viewer { position:relative; display:inline-block; }
    video { border:2px solid #444; border-radius:8px; background:#000; }
    #roi-box { position:absolute; border:2px dashed red; width:250px; height:60px; top:320px; left: calc(50% - 125px); pointer-events:none; box-sizing:border-box; }
    #result { font-size:20px; font-weight:bold; color:green; margin-top:12px; min-height:28px; }
    #controls { margin-top:12px; }
    button { margin:0 6px; padding:6px 12px; }
    /* preview Ø¯Ø§Ø®Ù„ Ù†ÙØ³ Ù…Ø±Ø¨Ø¹ ROI Ù„ÙŠØ¨ÙŠÙ‘Ù† Ù…Ø§ ÙŠÙØ±Ø³Ù„ Ù„Ù„Ù€ OCR */
    #previewOverlay { position:absolute; top:0; left:0; pointer-events:none; display:none; }
  </style>
</head>
<body>
  <h3>OCR Tawkeel Reliable Scanner</h3>

  <div class="viewer" id="viewer">
    <video id="video" autoplay playsinline width="640" height="480"></video>
    <div id="roi-box"></div>
    <canvas id="previewOverlay" width="250" height="60"></canvas>
  </div>

  <!-- ÙƒØ§Ù†Ú¤Ø§Ø³ Ø®Ù„ÙÙŠ Ù„Ù„Ø±Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„ (Ù…Ø®ÙÙŠ) ÙˆÙƒØ§Ù†Ú¤Ø§Ø³ ROI Ù…ÙØµØºÙ‘Ø± -->
  <canvas id="canvas" width="640" height="480" style="display:none"></canvas>
  <canvas id="roiCanvas" width="360" height="80" style="display:none"></canvas>

  <div id="result">Waiting...</div>
  <div id="controls">
    <button id="restartBtn">ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©</button>
    <button id="togglePreviewBtn">Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©</button>
  </div>

<script>
  const video = document.getElementById('video');
  const canvas = document.getElementById('canvas');
  const ctx = canvas.getContext('2d', { willReadFrequently: true });
  const roiCanvas = document.getElementById('roiCanvas');
  const roiCtx = roiCanvas.getContext('2d', { willReadFrequently: true });
  const previewOverlay = document.getElementById('previewOverlay');
  const previewCtx = previewOverlay.getContext('2d');
  const viewer = document.getElementById('viewer');
  const roiBox = document.getElementById('roi-box');
  const resultBox = document.getElementById('result');
  const restartBtn = document.getElementById('restartBtn');
  const togglePreviewBtn = document.getElementById('togglePreviewBtn');

  // Ø§Ø­ØªÙØ¸ Ø¨Ù†ÙØ³ regex Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ Ø¯ÙˆÙ† ØªØºÙŠÙŠØ±
  const TARGET_REGEX = /ECP\d{8}EG/;

  // Ø§Ø¶Ø¨Ø· ROI Ù‡Ù†Ø§ Ù„ÙŠØªØ·Ø§Ø¨Ù‚ Ù…Ø¹ Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø³Ø·Ø± ØªØ­Øª Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ ÙÙŠ ÙƒØ§Ù…ÙŠØ±ØªÙƒ
  const ROI = { x: 200, y: 320, w: 250, h: 60 }; // Ø¹Ø¯Ù‘Ù„ X, Y Ø­Ø³Ø¨ Ø§Ù„Ø­Ø§Ø¬Ø©

  // Ù…ÙˆØ§ØµÙØ§Øª Ø§Ù„Ø£Ø¯Ø§Ø¡ ÙˆØ§Ù„Ø³Ù„ÙˆÙƒ
  let scanning = true;
  let ocrRunning = false;
  let workerReady = false;
  let lastAttempt = 0;
  const minInterval = 500;
  const requiredStable = 2;
  let lastText = null;
  let stableCount = 0;
  let showPreview = false;

  // Ù…Ø²Ø§Ù…Ù†Ø© Ø¹Ø±Ø¶ Ø§Ù„Ù€ preview Ø¯Ø§Ø®Ù„ Ù…Ø±Ø¨Ø¹ ROI
  function syncPreviewPosition() {
    // ØªØ­Ø¯ÙŠØ¯ Ø§Ø¨Ø¹Ø§Ø¯ Ø§Ù„Ù…Ø±Ø¨Ø¹ Ø§Ù„Ø£Ø­Ù…Ø± (roiBox) Ø¨Ø§Ù„Ù†Ø³Ø¨Ø© Ù„Ù„Ù€ viewer
    const vb = viewer.getBoundingClientRect();
    const rb = roiBox.getBoundingClientRect();
    // Ø¶Ø¨Ø· Ù…Ù‚Ø§Ø³ Ø§Ù„Ù€ previewOverlay Ù„ÙƒÙŠ ÙŠÙƒÙˆÙ† ÙÙˆÙ‚ Ø§Ù„Ù…Ø±Ø¨Ø¹ Ø§Ù„Ø£Ø­Ù…Ø±
    previewOverlay.style.display = showPreview ? 'block' : 'none';
    previewOverlay.style.left = (rb.left - vb.left) + 'px';
    previewOverlay.style.top = (rb.top - vb.top) + 'px';
    previewOverlay.width = rb.width;
    previewOverlay.height = rb.height;
  }

  togglePreviewBtn.addEventListener('click', () => {
    showPreview = !showPreview;
    togglePreviewBtn.innerText = showPreview ? 'Ø§Ø®ÙØ§Ø¡ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©' : 'Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©';
    syncPreviewPosition();
  });

  window.addEventListener('resize', syncPreviewPosition);
  // ØªØ£ÙƒØ¯ Ø£Ù† Ø§Ù„Ù…Ø±Ø¨Ø¹ Ø§Ù„Ø£Ø­Ù…Ø± Ù…ÙˆÙ‚Ù‘Ø¹ Ù†Ø³Ø¨ÙŠØ§Ù‹ Ø¯Ø§Ø®Ù„ viewer (CSS Ø£Ø¹Ù„Ø§Ù‡ ÙŠØ¶Ù…Ù† Ø°Ù„Ùƒ)

  // ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§
  navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
    .then(s => { video.srcObject = s; })
    .catch(e => { resultBox.innerText = "Camera error: " + e; });

  // ØªÙ‡ÙŠØ¦Ø© worker ÙˆØ§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø¬Ø§Ù‡Ø²ÙŠØ© Ù‚Ø¨Ù„ Ø§Ù„Ø¨Ø¯Ø¡
  let worker;
  (async () => {
    worker = Tesseract.createWorker({ logger: m => { /* console.log(m) */ } });
    await worker.load();
    await worker.loadLanguage('eng');
    await worker.initialize('eng');
    await worker.setParameters({
      tessedit_char_whitelist: 'ECP0123456789EG',
      tessedit_pageseg_mode: Tesseract.PSM.SINGLE_LINE,
      tessedit_ocr_engine_mode: Tesseract.OEM.LSTM_ONLY
    });
    workerReady = true;
    // Ø¥Ø°Ø§ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø¬Ø§Ù‡Ø² Ø£ÙŠØ¶Ø§Ù‹ØŒ Ù†Ø¨Ø¯Ø£ Ø§Ù„Ø­Ù„Ù‚Ø©
    if (!video.paused && !video.ended) startLoop();
  })();

  // Ù†Ù†ØªØ¸Ø± Ø­Ø¯Ø« playing Ù„Ø¶Ù…Ø§Ù† Ø£Ø¨Ø¹Ø§Ø¯ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø¬Ø§Ù‡Ø²Ø©
  video.addEventListener('playing', () => {
    // Ù…Ø²Ø§Ù…Ù†Ø© Ù…ÙˆØ¶Ø¹ Ø§Ù„Ù€ preview Ù…Ø¹ Ø§Ù„Ù…Ø±Ø¨Ø¹ Ø§Ù„Ø£Ø­Ù…Ø± (Ø¨Ù…Ø§ Ø£Ù† Ø£Ø¨Ø¹Ø§Ø¯ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø¬Ø§Ù‡Ø²Ø© Ø§Ù„Ø¢Ù†)
    syncPreviewPosition();
    if (workerReady) startLoop();
  });

  // ØªØ­Ø¶ÙŠØ± Ø§Ù„Ù€ ROI: Ù‚ØµÙ‘ØŒ ØªØºÙŠÙŠØ± Ø­Ø¬Ù…ØŒ grayscaleØŒ contrastØŒ threshold
  function prepareROIBlob() {
    // Ø±Ø³Ù… ÙØ±ÙŠÙ… Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø¹Ù„Ù‰ Ø§Ù„ÙƒØ§Ù†Ú¤Ø§Ø³ Ø§Ù„ÙƒØ§Ù…Ù„
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

    // Ù‚Øµ Ø§Ù„Ù€ ROI ÙˆØ±Ø³Ù…Ù‡ Ø¹Ù„Ù‰ roiCanvas Ø¨Ø­Ø¬Ù… Ù…ØµØºÙ‘Ø±
    const targetW = roiCanvas.width;
    const targetH = roiCanvas.height;
    roiCtx.clearRect(0,0,targetW,targetH);
    // ØªØ£ÙƒØ¯ Ù…Ù† Ø¹Ø¯Ù… Ø§Ù„Ø®Ø±ÙˆØ¬ Ø¹Ù† Ø­Ø¯ÙˆØ¯ Ø§Ù„ÙƒØ§Ù†Ú¤Ø§Ø³
    const sx = Math.max(0, Math.min(canvas.width - 1, ROI.x));
    const sy = Math.max(0, Math.min(canvas.height - 1, ROI.y));
    const sw = Math.max(1, Math.min(ROI.w, canvas.width - sx));
    const sh = Math.max(1, Math.min(ROI.h, canvas.height - sy));

    roiCtx.drawImage(canvas, sx, sy, sw, sh, 0, 0, targetW, targetH);

    // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØµÙˆØ±Ø©: grayscale -> contrast -> threshold (Ø«Ø§Ø¨Øª Ø¨Ø¹Ø¯ ØªØ­Ø³ÙŠÙ†)
    const img = roiCtx.getImageData(0,0,targetW,targetH);
    const data = img.data;
    const contrast = 1.5;
    const intercept = 128 * (1 - contrast);
    for (let i = 0; i < data.length; i += 4) {
      const g = 0.299*data[i] + 0.587*data[i+1] + 0.114*data[i+2];
      let v = g * contrast + intercept;
      data[i] = data[i+1] = data[i+2] = v;
    }
    const thresh = 150;
    for (let i = 0; i < data.length; i += 4) {
      const v = data[i] > thresh ? 255 : 0;
      data[i] = data[i+1] = data[i+2] = v;
    }
    roiCtx.putImageData(img, 0, 0);

    // Ø¹Ø±Ø¶ Ø§Ù„Ù€ preview Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…Ø±Ø¨Ø¹ Ø§Ù„Ø£Ø­Ù…Ø± (Ù…ØªÙ…Ø±ÙƒØ² ÙˆÙ…Ù‚Ø§Ø³ Ù…Ø·Ø§Ø¨Ù‚)
    if (showPreview) {
      previewCtx.clearRect(0,0,previewOverlay.width, previewOverlay.height);
      // Ø§Ø±Ø³Ù… Ù†Ø³Ø®Ø© Ù…Ù† roiCanvas Ø¹Ù„Ù‰ preview (ØªÙƒÙŠÙŠÙ Ø§Ù„Ø£Ø¨Ø¹Ø§Ø¯ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹)
      previewCtx.drawImage(roiCanvas, 0, 0, previewOverlay.width, previewOverlay.height);
    }

    // Ø¥Ø±Ø¬Ø§Ø¹ blob Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ù„ÙŠØ³ ÙØ§Ø±ØºØ§Ù‹
    return new Promise(resolve => {
      roiCanvas.toBlob(blob => {
        // ÙØ­Øµ Ø¨Ø³ÙŠØ· Ù„Ø­Ø¬Ù… Ø§Ù„Ù€ blob Ù„Ù…Ù†Ø¹ Ø¥Ø±Ø³Ø§Ù„ ØµÙˆØ± ÙØ§Ø±ØºØ©
        if (!blob || blob.size < 200) {
          resolve(null);
        } else {
          resolve(blob);
        }
      }, 'image/png');
    });
  }

  async function doOCR() {
    if (!scanning || ocrRunning || !workerReady) return;
    const now = Date.now();
    if (now - lastAttempt < minInterval) return;
    lastAttempt = now;
    ocrRunning = true;
    try {
      const blob = await prepareROIBlob();
      if (!blob) {
        // blob ØºÙŠØ± ØµØ§Ù„Ø­ => Ù„Ø§ Ù†Ø±Ø³Ù„ Ù„Ù„Ù€ worker
        resultBox.innerText = "Preview empty or too small, adjust ROI";
        ocrRunning = false;
        return;
      }
      const { data: { text } } = await worker.recognize(blob);
      const cleaned = (text || '').replace(/\s+/g, '');
      const match = cleaned.match(TARGET_REGEX); // Ø§Ø³ØªØ®Ø¯Ù…Øª Ø§Ù„Ø±ÙŠØ¬ÙŠÙƒØ³ ÙƒÙ…Ø§ Ù‡Ùˆ ØªÙ…Ø§Ù…Ø§Ù‹

      if (match) {
        const candidate = match[0];
        if (candidate === lastText) {
          stableCount++;
        } else {
          lastText = candidate;
          stableCount = 1;
        }
        if (stableCount >= requiredStable) {
          resultBox.innerText = "âœ… Detected: " + candidate;
          scanning = false;
        } else {
          resultBox.innerText = "Confirming: " + candidate + " (" + stableCount + "/" + requiredStable + ")";
        }
      } else {
        lastText = null;
        stableCount = 0;
        resultBox.innerText = "Waiting...";
      }
    } catch (err) {
      console.error('OCR error', err);
      resultBox.innerText = "OCR error";
    } finally {
      ocrRunning = false;
    }
  }

  // Ø­Ù„Ù‚Ø© Ø±Ø¦ÙŠØ³ÙŠØ©: ØªØ¹Ù…Ù„ ÙÙ‚Ø· Ø¥Ø°Ø§ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ ÙŠÙØ´ØºÙ‘Ù„ ÙˆØ§Ù„Ù€ worker Ø¬Ø§Ù‡Ø²
  let loopRunning = false;
  function startLoop() {
    if (loopRunning) return;
    loopRunning = true;
    scanning = true;
    resultBox.innerText = "Waiting...";
    function frame() {
      if (!scanning) { loopRunning = false; return; }
      doOCR();
      requestAnimationFrame(frame);
    }
    requestAnimationFrame(frame);
  }

  restartBtn.addEventListener('click', () => {
    scanning = true;
    lastText = null;
    stableCount = 0;
    resultBox.innerText = "Waiting...";
    if (workerReady && !video.paused) startLoop();
  });

  // ØªÙ†Ø¸ÙŠÙ Ø¹Ù†Ø¯ Ø§Ù„Ø®Ø±ÙˆØ¬
  window.addEventListener('beforeunload', async () => {
    if (worker) await worker.terminate();
  });

  // Ø¶Ø¨Ø· Ù…ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø±Ø¨Ø¹ Ø§Ù„Ø£Ø­Ù…Ø± Ø¹Ù…Ù„ÙŠØ§Ù‹ Ø¨Ø§Ù„Ù†Ø³Ø¨Ø© Ù„Ø£Ø¨Ø¹Ø§Ø¯ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶Ø©
  // (ÙŠØ³Ù…Ø­ Ø¨ØªØ¹Ø¯ÙŠÙ„ Ø¨Ø³ÙŠØ· ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø­Ø³Ø¨ Ø¹Ø±Ø¶ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ)
  function autoAlignROI() {
    const vw = video.videoWidth || 640;
    const vh = video.videoHeight || 480;
    const displayW = video.clientWidth;
    const displayH = video.clientHeight;
    // Ø¥Ø°Ø§ Ù„Ø§ Ù†Ù…Ù„Ùƒ Ø£Ø¨Ø¹Ø§Ø¯ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ© Ø§Ø³ØªØ¹Ù…Ù„ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ
    // Ù‡Ù†Ø§ Ù†Ø±ÙƒÙ‘Ø² Ø¹Ù„Ù‰ Ø¨Ù‚Ø§Ø¡ ROI Ø¶Ù…Ù† Ø¥Ø·Ø§Ø± Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶
    const centerX = Math.floor(displayW / 2 - ROI.w / 2);
    roiBox.style.left = centerX + 'px';
    // Ø£Ø¹Ù„Ù‰-ÙŠØ³Ø§Ø±: Ø§Ø³ØªØ®Ø¯Ù… ROI.y ÙƒÙ†Ù‚Ø·Ø© ØªÙ‚Ø±ÙŠØ¨ÙŠØ© Ø¹Ù…ÙˆØ¯ÙŠØ©
    roiBox.style.top = (ROI.y * (displayH / vh)) + 'px';
    syncPreviewPosition();
  }

  // Ø­Ø§ÙˆÙ„ Ù…Ø­Ø§Ø°Ø§Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¨Ø¹Ø¯ ØªØ´ØºÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ
  video.addEventListener('loadedmetadata', autoAlignROI);
  video.addEventListener('play', autoAlignROI);

</script>
</body>
</html>
